<div class="p-8 space-y-6 h-full overflow-y-auto bg-white rounded-2xl shadow-md">
  <!-- Header -->
  <div>
    <div class="flex items-center gap-3 mb-2">
      <lucide-icon [img]="Calendar" class="w-8 h-8 text-emerald-600" />
      <h1 class="text-2xl font-bold text-gray-800 m-0">Schedule New Appointment</h1>
    </div>
    <p class="text-gray-600 m-0">Create a new appointment for an existing client or add a new client to your practice.</p>
  </div>

  <!-- Error Message -->
  <div *ngIf="showError" class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4" role="alert">
    <strong class="font-bold">Error!</strong>
    <span class="block sm:inline ml-2">{{ errorMessage }}</span>
    <button (click)="showError = false" class="absolute top-0 bottom-0 right-0 px-4 py-3">
      <span class="sr-only">Dismiss</span>
      <span class="text-red-700 font-bold text-xl">&times;</span>
    </button>
  </div>

  <!-- Selector de tipo de appointment -->

  <div class="flex items-center gap-4 mb-6">
    <button class="bg-gray-100 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-200 transition-colors" (click)="appointmentType = 'internal'">
      Internal Client
    </button>
    <button class="bg-gray-100 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-200 transition-colors" (click)="appointmentType = 'external'">
      External Client
    </button>
  </div>

  <!-- Formulario para crear un appointment con un cliente registrado -->
  <form *ngIf="appointmentType === 'internal'" [formGroup]="internalAppointmentForm" (ngSubmit)="onSubmitInternalAppointment()" class="space-y-4">
    
    <div class="mb-4 flex flex-col">
      <label for="search" class="font-semibold text-gray-700">Search for existing client *</label>
      <div class="relative">
        <input type="text" 
               id="search" 
               formControlName="clientId" 
               placeholder="Enter client name or email" 
               class="border p-2 rounded-md w-full"
               [class.border-red-500]="!selectedInternalClientId && internalAppointmentForm.get('clientId')?.touched"
               [class.border-gray-300]="selectedInternalClientId || !internalAppointmentForm.get('clientId')?.touched"
               (focus)="onFocusInternalSearch()"
               (blur)="onBlurInternalSearch()" />
        
        <!-- Error message for client selection -->
        <div *ngIf="!selectedInternalClientId && internalAppointmentForm.get('clientId')?.touched" 
             class="text-red-500 text-sm mt-1">
          Please select a client from the list
        </div>
        
        <!-- Lista de clientes internos filtrados -->
        <div *ngIf="filteredInternalClients.length > 0 && internalSearchFocused" class="absolute z-10 w-full bg-white border border-gray-300 rounded-md mt-1 max-h-40 overflow-y-auto shadow-lg">
          <div *ngFor="let client of filteredInternalClients" 
               (click)="selectInternalClient(client)" 
               class="p-3 hover:bg-blue-50 cursor-pointer border-b border-gray-100 last:border-b-0 transition-colors">
            <div class="font-medium text-gray-800">{{client.name}} {{client.lastName}}</div>
            <div class="text-sm text-gray-500">{{client.email}}</div>
          </div>
        </div>
        
        <!-- Mensaje de sugerencias -->
        <div *ngIf="filteredInternalClients.length === 0 && internalClients.length > 0 && internalSearchFocused" 
             class="absolute z-10 w-full bg-white border border-gray-200 rounded-md mt-1 p-3 text-sm text-gray-400 shadow-lg">
          Start typing to search clients...
        </div>
      </div>
    </div>

    <div class="mb-4 flex flex-col">
      <label for="date" class="font-semibold text-gray-700">Select appointment date *</label>
      <input type="date" 
             id="date" 
             formControlName="date" 
             class="border p-2 rounded-md"
             [class.border-red-500]="internalAppointmentForm.get('date')?.invalid && internalAppointmentForm.get('date')?.touched"
             [class.border-gray-300]="internalAppointmentForm.get('date')?.valid || !internalAppointmentForm.get('date')?.touched" />
      
      <!-- Error message for date -->
      <div *ngIf="internalAppointmentForm.get('date')?.invalid && internalAppointmentForm.get('date')?.touched" 
           class="text-red-500 text-sm mt-1">
        Date is required
      </div>
    </div>

    <div class="mb-4 flex flex-col">
      <label for="availability" class="font-semibold text-gray-700">Select appointment time *</label>
      
      <!-- Loading state -->
      <div *ngIf="loadingTimeSlots" class="flex items-center justify-center p-4">
        <div class="text-gray-500">Loading available time slots...</div>
      </div>
      
      <!-- Time slots grid -->
      <div *ngIf="!loadingTimeSlots && availableTimeSlots.length > 0" class="grid grid-cols-3 gap-2 mt-2">
        <div *ngFor="let slot of availableTimeSlots" 
             (click)="selectTimeSlot(slot)"
             class="p-3 border rounded-md cursor-pointer transition-all hover:bg-blue-50 hover:border-blue-300"
             [class.bg-blue-100]="selectedTimeSlot?.id === slot.id"
             [class.border-blue-500]="selectedTimeSlot?.id === slot.id"
             [class.border-gray-300]="selectedTimeSlot?.id !== slot.id">
          <div class="text-sm font-medium text-center">
            {{formatTimeSlot(slot)}}
          </div>
        </div>
      </div>
      
      <!-- No slots available -->
      <div *ngIf="!loadingTimeSlots && availableTimeSlots.length === 0 && internalAppointmentForm.get('date')?.value" 
           class="p-4 text-center text-gray-500 border border-gray-200 rounded-md">
        No time slots available for the selected date
      </div>
      
      <!-- Select date first -->
      <div *ngIf="!internalAppointmentForm.get('date')?.value" 
           class="p-4 text-center text-gray-400 border border-gray-200 rounded-md">
        Please select a date first
      </div>
      
      <!-- Error message for time slot selection -->
      <div *ngIf="!selectedTimeSlot && internalAppointmentForm.get('date')?.value && availableTimeSlots.length > 0" 
           class="text-red-500 text-sm mt-2">
        Please select a time slot
      </div>
    </div>

    <div class="mb-4 flex flex-col">
      <label for="notes" class="font-semibold text-gray-700">Additional notes</label>
      <textarea id="notes" formControlName="notes" rows="3" placeholder="Any additional information..." class="border border-gray-300 p-2 rounded-md"></textarea>
    </div>

    <button type="submit" class="bg-emerald-600 text-white px-4 py-2 rounded-md hover:bg-emerald-700 transition-colors">
      Create Appointment
    </button>

  </form>

  <!-- Formulario para crear un appointment con un cliente externo -->
   <form *ngIf="appointmentType == 'external'" [formGroup]="externalAppointmentForm" (ngSubmit)="onSubmitExternalAppointment()" class="space-y-4">
    <div class="mb-4 flex flex-col" *ngIf="!createNewClient">
      <button type="button" (click)="createNewClient = true" class="bg-gray-100 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-200 transition-colors">New Client</button>
    </div>
    <div class="mb-4 flex flex-col" *ngIf="createNewClient">
      <button type="button" (click)="createNewClient = false" class="bg-gray-100 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-200 transition-colors">Existing Client</button>
    </div>

    <!-- Campos para cliente existente -->
    <div *ngIf="!createNewClient" class="mb-4 flex flex-col">
      <label for="searchExternal" class="font-semibold text-gray-700">Search for existing client *</label>
      <div class="relative">
        <input type="text" 
               id="searchExternal" 
               formControlName="externalClientId" 
               placeholder="Enter client name or email" 
               class="border p-2 rounded-md w-full"
               [class.border-red-500]="!selectedExternalClientId && externalAppointmentForm.get('externalClientId')?.touched"
               [class.border-gray-300]="selectedExternalClientId || !externalAppointmentForm.get('externalClientId')?.touched"
               (focus)="onFocusExternalSearch()"
               (blur)="onBlurExternalSearch()" />
        
        <!-- Error message for external client selection -->
        <div *ngIf="!selectedExternalClientId && externalAppointmentForm.get('externalClientId')?.touched" 
             class="text-red-500 text-sm mt-1">
          Please select a client from the list
        </div>
        
        <!-- Lista de clientes externos filtrados -->
        <div *ngIf="filteredExternalClients.length > 0 && externalSearchFocused" class="absolute z-10 w-full bg-white border border-gray-300 rounded-md mt-1 max-h-40 overflow-y-auto shadow-lg">
          <div *ngFor="let client of filteredExternalClients" 
               (click)="selectExternalClient(client)" 
               class="p-3 hover:bg-blue-50 cursor-pointer border-b border-gray-100 last:border-b-0 transition-colors">
            <div class="font-medium text-gray-800">{{client.name}} {{client.lastName}}</div>
            <div class="text-sm text-gray-500">{{client.email}}</div>
          </div>
        </div>
        
        <!-- Mensaje de sugerencias -->
        <div *ngIf="filteredExternalClients.length === 0 && externalClients.length > 0 && externalSearchFocused" 
             class="absolute z-10 w-full bg-white border border-gray-200 rounded-md mt-1 p-3 text-sm text-gray-400 shadow-lg">
          Start typing to search clients...
        </div>
      </div>
    </div>

    <!-- Campos para nuevo cliente -->
    <div *ngIf="createNewClient" [formGroup]="newClientForm">
      <div class="mb-4 flex flex-col">
        <label for="clientName" class="font-semibold text-gray-700">Client Name *</label>
        <input type="text" 
               id="clientName" 
               formControlName="name" 
               placeholder="Enter client name" 
               class="border p-2 rounded-md"
               [class.border-red-500]="newClientForm.get('name')?.invalid && newClientForm.get('name')?.touched"
               [class.border-gray-300]="newClientForm.get('name')?.valid || !newClientForm.get('name')?.touched" />
        
        <div *ngIf="newClientForm.get('name')?.invalid && newClientForm.get('name')?.touched" 
             class="text-red-500 text-sm mt-1">
          Name is required
        </div>
      </div>
      
      <div class="mb-4 flex flex-col">
        <label for="clientLastName" class="font-semibold text-gray-700">Client Last Name *</label>
        <input type="text" 
               id="clientLastName" 
               formControlName="lastName" 
               placeholder="Enter client last name" 
               class="border p-2 rounded-md"
               [class.border-red-500]="newClientForm.get('lastName')?.invalid && newClientForm.get('lastName')?.touched"
               [class.border-gray-300]="newClientForm.get('lastName')?.valid || !newClientForm.get('lastName')?.touched" />
        
        <div *ngIf="newClientForm.get('lastName')?.invalid && newClientForm.get('lastName')?.touched" 
             class="text-red-500 text-sm mt-1">
          Last name is required
        </div>
      </div>

      <div class="mb-4 flex flex-col">
        <label for="clientEmail" class="font-semibold text-gray-700">Client Email *</label>
        <input type="email" 
               id="clientEmail" 
               formControlName="email" 
               placeholder="Enter client email" 
               class="border p-2 rounded-md"
               [class.border-red-500]="newClientForm.get('email')?.invalid && newClientForm.get('email')?.touched"
               [class.border-gray-300]="newClientForm.get('email')?.valid || !newClientForm.get('email')?.touched" />
        
        <div *ngIf="newClientForm.get('email')?.invalid && newClientForm.get('email')?.touched" 
             class="text-red-500 text-sm mt-1">
          <span *ngIf="newClientForm.get('email')?.errors?.['required']">Email is required</span>
          <span *ngIf="newClientForm.get('email')?.errors?.['email']">Please enter a valid email address</span>
        </div>
      </div>

      <div class="mb-4 flex flex-col">
        <label for="clientPhone" class="font-semibold text-gray-700">Client Phone *</label>
        <input type="tel" 
               id="clientPhone" 
               formControlName="phone" 
               placeholder="Enter client phone" 
               class="border p-2 rounded-md"
               [class.border-red-500]="newClientForm.get('phone')?.invalid && newClientForm.get('phone')?.touched"
               [class.border-gray-300]="newClientForm.get('phone')?.valid || !newClientForm.get('phone')?.touched" />
        
        <div *ngIf="newClientForm.get('phone')?.invalid && newClientForm.get('phone')?.touched" 
             class="text-red-500 text-sm mt-1">
          Phone is required
        </div>
      </div>

    </div>

    <div class="mb-4 flex flex-col">
      <label for="dateExternal" class="font-semibold text-gray-700">Select appointment date *</label>
      <input type="date" 
             id="dateExternal" 
             formControlName="date" 
             class="border p-2 rounded-md"
             [class.border-red-500]="externalAppointmentForm.get('date')?.invalid && externalAppointmentForm.get('date')?.touched"
             [class.border-gray-300]="externalAppointmentForm.get('date')?.valid || !externalAppointmentForm.get('date')?.touched" />
      
      <!-- Error message for external date -->
      <div *ngIf="externalAppointmentForm.get('date')?.invalid && externalAppointmentForm.get('date')?.touched" 
           class="text-red-500 text-sm mt-1">
        Date is required
      </div>
    </div>

    <div class="mb-4 flex flex-col">
      <label for="availabilityExternal" class="font-semibold text-gray-700">Select appointment time *</label>
      
      <!-- Loading state -->
      <div *ngIf="loadingTimeSlots" class="flex items-center justify-center p-4">
        <div class="text-gray-500">Loading available time slots...</div>
      </div>
      
      <!-- Time slots grid -->
      <div *ngIf="!loadingTimeSlots && availableTimeSlots.length > 0" class="grid grid-cols-3 gap-2 mt-2">
        <div *ngFor="let slot of availableTimeSlots" 
             (click)="selectTimeSlot(slot)"
             class="p-3 border rounded-md cursor-pointer transition-all hover:bg-blue-50 hover:border-blue-300"
             [class.bg-blue-100]="selectedTimeSlot?.id === slot.id"
             [class.border-blue-500]="selectedTimeSlot?.id === slot.id"
             [class.border-gray-300]="selectedTimeSlot?.id !== slot.id">
          <div class="text-sm font-medium text-center">
            {{formatTimeSlot(slot)}}
          </div>
        </div>
      </div>
      
      <!-- No slots available -->
      <div *ngIf="!loadingTimeSlots && availableTimeSlots.length === 0 && externalAppointmentForm.get('date')?.value" 
           class="p-4 text-center text-gray-500 border border-gray-200 rounded-md">
        No time slots available for the selected date
      </div>
      
      <!-- Select date first -->
      <div *ngIf="!externalAppointmentForm.get('date')?.value" 
           class="p-4 text-center text-gray-400 border border-gray-200 rounded-md">
        Please select a date first
      </div>
      
      <!-- Error message for external time slot selection -->
      <div *ngIf="!selectedTimeSlot && externalAppointmentForm.get('date')?.value && availableTimeSlots.length > 0" 
           class="text-red-500 text-sm mt-2">
        Please select a time slot
      </div>
    </div>

    <div class="mb-4 flex flex-col">
      <label for="notesExternal" class="font-semibold text-gray-700">Additional notes</label>
      <textarea id="notesExternal" formControlName="notes" rows="3" placeholder="Any additional information..." class="border border-gray-300 p-2 rounded-md"></textarea>
    </div>

    <button type="submit" class="bg-emerald-600 text-white px-4 py-2 rounded-md hover:bg-emerald-700 transition-colors">
      Create Appointment
    </button>

   </form>


</div>
